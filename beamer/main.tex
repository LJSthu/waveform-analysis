% !TEX program = pdflatex
\documentclass{beamer}
% \documentclass{beamer}

\usetheme{Madrid}
\usecolortheme{default}

\definecolor{THUpurple}{RGB}{102,8,116}

\usepackage{amsmath}
\usepackage{caption}
\usepackage{listings}
\usepackage{lmodern}
\usepackage{xcolor}
\lstset{language=Python,keywordstyle={\bfseries \color{blue}}}
\usepackage{pdfpages}
\usepackage{makecell}
\usepackage[EULERGREEK]{sansmath}
\usepackage{tikz}
\usefonttheme[onlymath]{serif}

\newcommand{\ud}{\mathrm{d}}
\newcommand{\mev}{\mathrm{MeV}}
\newcommand{\gev}{\mathrm{GeV}}

\setbeamercolor{structure}{fg=THUpurple}
\setbeamersize{text margin left=10mm,text margin right=10mm}
% \setlength{\belowcaptionskip}{-2mm}
\title[Waveform Analysis]{A Comprehensive Survey of PMT Waveform Analysis Methods}
\author[Dacheng Xu]{Dacheng Xu \and Erjin Bao \and Yiyang Wu  \\ Benda Xu \and Yu Xu \and Geliang Zhang \\ [8mm] \includegraphics[height=2cm]{img/Tsinghua_University_Logo.png}}
\date[DANCE]{August 4, 2020}

\AtBeginSection[]
{
    \begin{frame}[noframenumbering]
        \frametitle{Outline}
        \thispagestyle{empty}
        \tableofcontents[currentsection]
    \end{frame}
}

\begin{document}
\captionsetup[figure]{labelfont={bf},name={Fig}}
\frame{\titlepage}

\begin{frame}[noframenumbering]
\frametitle{Outline}
\thispagestyle{empty}
\tableofcontents
\end{frame}

\section{Motivation}
\begin{frame}
\setcounter{page}{0}
\frametitle{CJPL}
\begin{figure}
    \centering
    \caption{China JinPing Underground Laboratory}
    \includegraphics[width=0.65\linewidth]{img/WorldMap.jpg}
\end{figure}
\begin{itemize}
    \item Overburden $\sim2400\mathrm{m}$
    \item Extremely low cosmic-ray $\mu$ flux
    \item Low reactor neutrino flux
    \item Ideal site of low background physics research
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Jinping Neutrino Experiment}
\setlength{\abovecaptionskip}{-2mm}
\vspace{-4mm}
\begin{columns}
\column{0.33\textwidth}
\begin{center}
    Ongoing
\end{center}
\begin{figure}
    \centering
    \caption{1-ton prototype}
    \includegraphics[width=0.6\linewidth]{img/prototype.jpeg}
\end{figure}
\column{0.34\textwidth}
\begin{center}
    Next
\end{center}
\begin{figure}
    \centering
    \caption{$\sim$100t detector}
    \includegraphics[width=0.6\linewidth]{img/100tondetector.png}
\end{figure}
\column{0.33\textwidth}
\begin{center}
    Future
\end{center}
\begin{figure}
    \centering
    \caption{$\sim$5000t detector}
    \includegraphics[width=0.6\linewidth]{img/DetectoratJinping.jpg}
\end{figure}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Neutrino Detector}
\begin{columns}
\column{0.5\textwidth}
\begin{figure}
    \centering
    \caption{Future Detector at Jinping}
    \includegraphics[width=1.0\linewidth]{img/DetectoratJinping.jpg}
\end{figure}
\column{0.5\textwidth}
\begin{itemize}
    \item Study neutrino property based on interaction
    \item Study interaction based on light
    \item PMT: extremely sensitive detectors of light
\end{itemize}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Photomultiplier Tube}
\setlength{\abovecaptionskip}{0mm}
\setlength{\belowcaptionskip}{0mm}
\begin{columns}
\column{0.6\textwidth}
\begin{figure}
    \centering
    \caption{PMT}
    \includegraphics[width=0.3\linewidth]{img/PMT.png}
\end{figure}
\begin{figure}
    \centering
    \caption{PMT Single PE response}
    \includegraphics[width=0.9\linewidth]{img/pmtspe.png}
\end{figure}
\column{0.4\textwidth}
\begin{center}
    3 individual processes:
\end{center}
\begin{itemize}
    \item Photon-Electron conversion
    \item Electron collection
    \item Amplify
\end{itemize}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Naive Method}
\hspace{4mm}Naively, when handling PMT waveforms, we record:
\begin{itemize}
    \item First HitTime
    \item Integration of Waveform (Charge)
\end{itemize}
\begin{figure}
    \centering
    % \caption{Traditional Recorded Waveform}
    \includegraphics[width=0.8\linewidth]{img/previous.png}
\end{figure}
\end{frame}

\begin{frame}
\frametitle{New Goal}
\begin{itemize}
    \item Extract All Detailed Photon Information in 1 Window
    \item Including: HitTime (The time when electron hit first dynode) \& Charge or PEnumber
\end{itemize}
\begin{figure}
    \centering
    % \caption{Traditional Recorded Waveform}
    \includegraphics[width=0.8\linewidth]{img/goal.png}
\end{figure}
\end{frame}

\section{Wasserstein Distance \& Poisson Distance}
\begin{frame}
\frametitle{Measurement of difference}
\begin{center}
    The difference between Reconstruction Result \& Truth?
\end{center}
\end{frame}

\begin{frame}
\frametitle{Familiar Distances}
\begin{columns}
\column{0.3\textwidth}
\begin{itemize}
    \item $L_{1}$ : $\int|p-q|$
    \item $L_{2}$ : $\int(p-q)^{2}$
    \item $\chi^{2}$ : $\int\frac{(p-q)^{2}}{q}$
    \item $\cdots$
\end{itemize}
\column{0.7\textwidth}
Shortcoming:
\begin{itemize}
    \item Cannot compare discrete distribution with continuous distribution
    \item Ignore the geometry of space
\end{itemize}
\begin{figure}
    \centering
    \includegraphics[width=1.0\linewidth]{img/tab.png}
\end{figure}
\end{columns}
\end{frame}

\input{Wasserstain}

\begin{frame}
\frametitle{Wasserstein Distance Demo}
\setlength{\abovecaptionskip}{-2mm}
\setlength{\belowcaptionskip}{0mm}
$D_{w}=\sum|\mathrm{CDF}(a) - \mathrm{CDF}(b)|$ \\
$CDF$: Cumulative Distribution Function
\begin{columns}
\column{0.4\textwidth}
\begin{figure}
    \centering
    \includegraphics[width=1.0\linewidth]{img/a.png}
\end{figure}
\vspace{-7mm}
\begin{figure}
    \centering
    \includegraphics[width=1.0\linewidth]{img/b.png}
\end{figure}
\column{0.1\textwidth}
\begin{tikzpicture}
    \node[] at (-2.5, 1) (a1) {};
    \node[] at (-1, 0.5) (a2) {};
    \node[] at (-2.5, -1) (b1) {};
    \node[] at (-1, -0.5) (b2) {};
    \draw [->, line width=0.5mm] (a1) -- node[anchor=south] {CDF} (a2);
    \draw [->, line width=0.5mm] (b1) -- node[anchor=north] {CDF} (b2);
\end{tikzpicture}
\column{0.5\textwidth}
\vspace{2mm}\begin{figure}
    \centering
    \includegraphics[width=1.0\linewidth]{img/ab.png}
\end{figure}
\rightline{W-dist = $1.8\mathrm{ns}$}
\end{columns}
This definition of distance is equivalent to Wasserstein Distance
\end{frame}

\begin{frame}
\frametitle{Poisson Distance}
\hspace{4mm}Poisson Distance is used \textbf{only} when reconstruct PEnumber
\begin{itemize}
    \item $Q = \sum PEnumber_{truth_i}; q = \sum PEnumber_{recon_i}$
    \item $D_{p} = |Q-q|*Poisson(Q|Q)$
\end{itemize}
\end{frame}

\section{Methods}

\begin{frame}
\frametitle{Input \& Output, Loss}
\begin{columns}
\column{0.4\textwidth}
\hspace{4mm}Input \& Output:
\begin{itemize}
    \item Input: Pedestal deduced PMT waveform
    \item Output: Weight (Charge or PEnumber) sequence
\end{itemize}
\column{0.6\textwidth}
\setlength{\abovecaptionskip}{-2mm}
\setlength{\belowcaptionskip}{0mm}
\begin{figure}
    \centering
    \includegraphics[width=0.9\linewidth]{img/wave.png}
    \includegraphics[width=0.9\linewidth]{img/charge.png}
\end{figure}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Data Sample}
% PEpos is the count of HitTime
\begin{columns}
\column{0.6\textwidth}
\begin{figure}
    \centering
    \caption{Data Structure}
    \includegraphics[width=1.0\linewidth]{img/pepos.png}
\end{figure}
\column{0.4\textwidth}
\begin{figure}
    \centering
    \caption{Data Structure}
    \includegraphics[width=1.0\linewidth]{img/dataset.png}
\end{figure}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Find Peak}
\begin{figure}
    \centering
    \caption{Find Peak Method Demo, W-dist = 2.72}
    \includegraphics[width=0.9\linewidth]{img/findpeak.png}
\end{figure}
\vspace{-4mm}
\begin{center}
    Average W-dist = 12.3
\end{center}
\end{frame}

\begin{frame}
\frametitle{Waveform Shift}
\begin{figure}
    \centering
    \caption{Waveform Shift Method Demo, W-dist = 3.10}
    \includegraphics[width=0.9\linewidth]{img/threshold.png}
\end{figure}
\vspace{-4mm}
\begin{center}
    Average W-dist = 3.92
\end{center}
\end{frame}

\begin{frame}
\frametitle{Fast Fourier Transform}
\begin{columns}
\column{0.6\textwidth}
\begin{figure}
    \centering
    \caption{Fast Fourier Transform Demo, W-dist = 1.22}
    \includegraphics[width=1.0\linewidth]{img/fftrans.png}
\end{figure}
\vspace{-4mm}
\begin{center}
    Average W-dist = 2.1
\end{center}
\column{0.4\textwidth}
\begin{enumerate}
    \item FFT of Waveform \& Single PE response
    \item Rectangular filter of FFT(Waveform)
    \item FFT(Charge) = FFT(Waveform) / FFT(SPE)
    \item IFFT of FFT(Charge)
\end{enumerate}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Lucy Deconvolution}
\begin{columns}
\column{0.6\textwidth}
\begin{figure}
    \centering
    \caption{Lucy Deconvolution Demo, W-dist = 1.31}
    \includegraphics[width=1.0\linewidth]{img/lucyddm.png}
\end{figure}
\vspace{-4mm}
\begin{center}
    Average W-dist = 1.45
\end{center}
\column{0.4\textwidth}
\begin{enumerate}
    \item Lucy-Richardson deconvolution
    \item A nonlinear iterative method
    \item Prohibit Charge $<$ 0
\end{enumerate}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{CNN Structure}
\begin{columns}
\column{0.35\textwidth}
\begin{figure}[H]
    \centering
    \caption{CNN Structure}
    \includegraphics[width=0.8\textwidth]{img/model.png}
\end{figure}
\column{0.65\textwidth}
\lstinputlisting[language=Python, basicstyle=\tiny]{CNN}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Training Process}
\begin{columns}
\column{0.35\textwidth}
\begin{itemize}
    \item Train CNN by each Channel (30PMTs)
    \item $\sim$280k waveform for each Channel
    \item epoch = 36
    \item Learning rate = $0.01$
\end{itemize}
\column{0.65\textwidth}
\begin{figure}
    \centering
    \caption{Data Structure}
    \includegraphics[width=1.0\linewidth]{img/epoch.png}
\end{figure}
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Single PE Model}
\begin{figure}
    \centering
    \caption{Single PE Model}
    \includegraphics[width=0.9\linewidth]{img/spe.png}
\end{figure}
\end{frame}

\begin{frame}
\frametitle{Fitting Process}
\begin{itemize}
    \item Fitting parameter: Weight in each HitTime
    \item loss is Residual sum squares of Waveform
    \item Loss = $\sum(Wave_{recon}-Wave_{truth})^{2}$
    \item using \lstinline{scipy.optimize.fmin_l_bfgs_b}
\end{itemize}
\setlength{\belowcaptionskip}{0mm}
\begin{figure}
    \centering
    \caption{Fitting Demo}
    \includegraphics[width=0.7\linewidth]{img/demo.png}
\end{figure}
\end{frame}

\section{Result}
\begin{frame}
\frametitle{Distances}
\setlength{\belowcaptionskip}{0mm}
\begin{table}
    \centering
    \caption{Reconstruction Result($\pm1\sigma$)}
    \begin{tabular}{c|c|c|c}
        \hline
        &  & W-dist/$\mathrm{ns}$ & P-dist/$\mathrm{1}$ \\
        \hline
        FindPeak & Charge & $12.3\pm18.5$ & - \\
        \hline
        FindPeak & PEnum & $15.58\pm18.8$ & $0.32\pm0.3$ \\
        \hline
        Threshold & Charge & $3.92\pm3.6$ & - \\
        \hline
        Threshold & PEnum & $7.55\pm8.1$ & $0.30\pm0.2$ \\
        \hline
        FFT & Charge & $2.14\pm4.1$ & - \\
        \hline
        FFT & PEnum & $6.68\pm8.0$ & $0.24\pm0.2$ \\
        \hline
        LucyDDM & Charge & $1.45\pm2.5$ & - \\
        \hline
        LucyDDM & PEnum & $6.19\pm6.9$ & $0.30\pm0.2$ \\
        \hline
        CNN & Charge & $1.76\pm3.3$ & - \\
        \hline
        CNN & PEnum & - & - \\
        \hline
        Fitting & Charge & $0.91\pm1.5$ & - \\
        \hline
        Fitting & PEnum & $2.62\pm6.3$ & $0.12\pm0.2$ \\
        \hline
    \end{tabular}
\end{table}
\end{frame}

\begin{frame}
\frametitle{CNN Result Histogram}
\begin{figure}
    \centering
    \caption{CNN Charge Result Histogram}
    \includegraphics[width=1.0\linewidth]{img/takarahist.png}
\end{figure}
\end{frame}

\begin{frame}
\frametitle{CNN Result Histogram}
\setlength{\abovecaptionskip}{0mm}
\setlength{\belowcaptionskip}{0mm}
\begin{figure}
    \centering
    \caption{W-dist vs PEpos}
    \includegraphics[width=0.9\linewidth]{img/takarastats.png}
\end{figure}
\end{frame}

\begin{frame}
\frametitle{Fitting Result Histogram}
\begin{figure}
    \centering
    \caption{Fitting Charge Result Histogram}
    \includegraphics[width=1.0\linewidth]{img/xiaopeiphist.png}
\end{figure}
\end{frame}

\begin{frame}
\frametitle{Fitting Result Histogram}
\setlength{\abovecaptionskip}{0mm}
\setlength{\belowcaptionskip}{0mm}
\begin{columns}
\column{0.7\textwidth}
\begin{figure}
    \centering
    \caption{W-dist vs PEpos}
    \includegraphics[width=0.9\linewidth]{img/xiaopeipstats.png}
\end{figure}
\column{0.3\textwidth}
PEpos is the count of distinct HitTime
\end{columns}
\end{frame}

\begin{frame}
\frametitle{Efficiency}
\begin{table}
    \centering
    \caption{Reconstruction Efficiency}
    \begin{tabular}{c|c|c}
        \hline
        &  & Performance \\
        \hline
        CNN & Charge & 6.0s/$10^{5}$Wf(1gpu) \\
        \hline
        CNN & PEnum & -s/$10^{5}$Wf(1gpu)\\
        \hline
        Fitting & Charge & 1230s/$10^{5}$Wf(50cpu) \\
        \hline
        Fitting & PEnum & 1570s/$10^{5}$Wf(50cpu) \\
        \hline
    \end{tabular}
\end{table}
\end{frame}

\section{Summary \& Outlook}
\begin{frame}
\frametitle{Summary \& Outlook}
\begin{itemize}
    \item We developed several representative methods to extract photon information hidden in PMT waveform
    \item These methods will improve the accuracy of following-up Event reconstruction
    \item We are working on applying and connecting these methods to Event reconstruction
\end{itemize}
\end{frame}

\appendix
\section{Backup}
\begin{frame}[noframenumbering]
\thispagestyle{empty}
\frametitle{Backup}
    
\end{frame}

\end{document}