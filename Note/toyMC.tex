\section{Motivation}
\label{sec:toyMC}

In this section, we discuss the crucialness of waveform analysis for time measurements in PMT-based experiments.

\subsection{Light curve}
A particle interacts with matter and deposits energy when passing through the detector. Part of such energy converts into visible Cherenkov or scintillation photons. The time distribution of the photons is called the \textit{light curve}.  We formulate the scintillation light curve as several exponentials with different decay rates~\cite{rebber_particle_2021} and instantaneous Cherenkov light curve by a Dirac delta function.  The effective light curve $\phi(t)$ of PEs is smeared by the PMT transit time spread~(TTS), giving an \textit{ex-Gaussian} or \textit{exponentially modified Gaussian}~\cite{li_separation_2016},
\begin{align}
    \phi(t) = \frac{1}{2\tau_\mathrm{l}} \exp\left(\frac{\sigma_\mathrm{l}^2}{2\tau_\mathrm{l}^2}-\frac{t}{\tau_\mathrm{l}}\right) \left[1 - \erf\left( \frac{\sigma_\mathrm{l}}{\sqrt{2}\tau_\mathrm{l}} - \frac{t}{\sqrt{2}\sigma_\mathrm{l}} \right)\right]
    \label{eq:time-pro}
\end{align}
where subscript $\mathrm{l}$ stands for ``light curve'' and $\sigma_\mathrm{l}$ encodes the timing uncertainty mainly from TTS. $\phi(t)$ of Cherenkov light is a pure Gaussian by taking $\tau_\mathrm{l} \rightarrow 0$. Figure~\ref{fig:time-pro} illustrates 3 examples of $\phi(t)$. 

\begin{figure}[!htb]
  \centering
  \resizebox{0.5\textwidth}{!}{\input{figures/profile.pgf}}
  \caption{\label{fig:time-pro} Effective light curves in 3 settings.  A scintillator paired with ultra-fast photo-sensors gives the green curve with $\tau_\mathrm{l} \gg \sigma_\mathrm{l}$.  A fast Cherenkov detector by the red curve has $\tau_\mathrm{l} \ll \sigma_\mathrm{l}$.  The blue curve combining $\tau_\mathrm{l}=\SI{20}{ns}$ and $\sigma_\mathrm{l}=\SI{5}{ns}$ represents a typical scintillation detector.  We can regard a normalized light curve as a probability density function of PEs.}
\end{figure}


\subsection{Single PE response}
\label{subsec:spe}

A PE induced by a photon at the PMT photocathode is then accelerated, collected, and amplified into $\num[retain-unity-mantissa=false]{\sim 1e7}$ electrons, forming a voltage pulse $V_\mathrm{PE}(t)$ in the PMT output.
\begin{figure}[H]
  \begin{subfigure}{.49\textwidth}
    \centering
    \resizebox{\textwidth}{!}{\input{figures/spe.pgf}}
    \caption{\label{fig:spe} Single PE response $V_\mathrm{PE}(t)$ in eq.~\eqref{eq:dayaspe}.}
  \end{subfigure}
  \begin{subfigure}{.49\textwidth}
    \centering
    \resizebox{\textwidth}{!}{\input{figures/wave.pgf}}
    \caption{\label{fig:pile} PE pile-up and white noise in a PMT waveform.}
  \end{subfigure}
  \caption{A single PE from a PMT induces a voltage pulse in \subref{fig:spe}.  Multiple PEs piling up at a PMT form a waveform in \subref{fig:pile}.  PEs are barely visually separable from each other.}
\end{figure}

S.~Jetter et al.~\cite{jetter_pmt_2012} parameterizes $V_\mathrm{PE}(t)$ as,
\begin{equation}
  V_\mathrm{PE}(t) = V_{0}\exp\left[-\frac{1}{2}\left(\frac{\log(t/\tau_\mathrm{PE})}{\sigma_\mathrm{PE}}\right)^{2}\right]
  \label{eq:dayaspe}
\end{equation}
where shape parameters $\tau_\mathrm{PE}=\SI{8}{ns}$, $\sigma_\mathrm{PE}=\SI{0.5}{ns}$ and $V_{0}=\SI{14.08}{mV}$, see figure~\ref{fig:spe}.  A sample of PEs from the light curve $\phi(t)$ in eq.~\eqref{eq:time-pro} can be formulated as several delta functions, 
\begin{equation}
  \label{eq:lc-sample}
  \tilde{\phi}(t) = \sum_{i=1}^{N_{\mathrm{PE}}} q_i \delta(t-t_i)
\end{equation}
where $N_\mathrm{PE}$ is the number of PEs, following Poisson distribution with parameter $\mu$.  $t_i$ is the hit time of the $i$-th PE, $q_i$ is the relative charge of the $i$-th PE from charge distribution $\mathcal{N}(1,\sigma_\mathrm{q}^2)$.  $\sigma_\mathrm{q}$ is set to $0.4$ in our simulation.

The PMT voltage output waveform $w(t)$ is a time series modeled by convolution of $\tilde{\phi}(t)$ and $V_\mathrm{PE}(t)$ added by a Gaussian white noise $\epsilon(t)$,
\begin{equation}
  \label{eq:1}
  w(t) = \tilde{\phi}(t) \otimes V_\mathrm{PE}(t) + \epsilon(t) = \sum_{i=1}^{N_\mathrm{PE}} q_i V_\mathrm{PE}(t-t_i) + \epsilon(t).
\end{equation}
See figure~\ref{fig:pile} for an example.


\subsection{Time measurement}
We see in figure~\ref{fig:pile} that pile-ups and noises hinder the resolution of PEs. Fortunately, we can use ... instead. it is the light curve shift $t_0$ that is the variable for time of flight in vertex reconstruction.  In this article, $\hat{t}$ denotes an estimator of $t_0$.

Classical TDC/QDC extracts the waveform's threshold crossing time $\hat{t}_\mathrm{1st}$ and the total charge $Q$ by integration.  $\hat{t}_\mathrm{1st}$ is a biased $t_0$ estimator affected by the light intensity $\mu$. We define the resolution $\sigma_\mathrm{1st}$ for a batch of waveforms as the standard deviation of $\Delta t_0 = \hat{t}_\mathrm{1st} - t_0$.

From a hypothetical perfect measurement of $t_i$, we define an ideal maximum likelihood estimator $\hat{t}_\mathrm{ALL}$,
\begin{equation}
  \label{eq:2}
  \hat{t}_\mathrm{ALL} = \arg\underset{t_0}{\max} \prod_{i=1}^{N_\mathrm{PE}} \phi(t_i-t_0).
\end{equation}
The corresponding $\sigma_\mathrm{ALL}$ is the lower bound of time resolution. 

To characterize $\hat{t}_\mathrm{1st}$ and $\hat{t}_\mathrm{ALL}$, we scan $\mu$ from \numrange{0}{30} for each light curve in figure~\ref{fig:time-pro} and generate a sample of $\num[retain-unity-mantissa=false]{1e4}$ waveforms for every triplet of $(\tau_\mathrm{l}, \sigma_\mathrm{l}, \mu)$.  Figure~\ref{fig:reso-diff} shows that $\sigma_{\mathrm{1st}}$ equals $\sigma_{\mathrm{ALL}}$ when $\tau_\mathrm{l} \gg \sigma_\mathrm{l}$, because $\hat{t}_\mathrm{ALL}$ is reduced to $\hat{t}_\mathrm{1st}$(=$\min_i t_i$) for an exponential light curve. For $\mu \to 0$, $\sigma_{\mathrm{1st}}$ and $\sigma_{\mathrm{ALL}}$ are also equal because at most 1 PE is available.  TDC/QDC is effective in those cases.

\begin{figure}[H]
  \centering
  \resizebox{0.8\textwidth}{!}{\input{figures/vs-deltadiv.pgf}}
  \caption{\label{fig:reso-diff} Time resolution comparisons between $\hat{t}_{\mathrm{ALL}}$~(solid lines, when using full PE information) and $\hat{t}_\mathrm{1st}$~(dashed lines, only using the first PE). The difference is manifested especially when $\sigma_\mathrm{l}$ and $\mu$ are large. The three cases of $(\tau_\mathrm{l}, \sigma_\mathrm{l})/\si{ns}$ represent the scintillation with ultra-fast PMTs~$(20, 0)$, Cherenkov~$(0, 5)$ and scintilation coupled with PMT TTS~$(20, 5)$. The performance of waveform analysis lies between $\sigma_{\mathrm{1st}}$ and $\sigma_{\mathrm{ALL}}$. }
\end{figure}

Nevertheless, for $\mu >0$ and $\sigma_\mathrm{l} > 0$, the $\sigma_{\mathrm{1st}}$ significantly deteriorates from $\sigma_{\mathrm{ALL}}$.  For Cherenkov and scintillation experiments with non-negligible PMT TTS and occupancy, we shall explore more sophisticated waveform analysis algorithms to recover the accuracy of $\hat{t}_\mathrm{ALL}$ in eq.~\eqref{eq:2} from waveform in eq.~\eqref{eq:1}.
