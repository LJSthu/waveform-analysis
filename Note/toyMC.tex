\section{Data Setup} % (fold)
\label{sec:toyMC}

\subsection{Light Curve}
In the PMT-based experiments, a particle interact with and deposit energy into the detector along its trajectory. Part of the deposited energy becomes visible as Cherenkov or scintillation photons.  The timing distribution of the emitted photons is called the \textit{light curve}.  A scintillation light curve of is modeled as a mixture of several exponential components with different decay rates~\cite{ludhova_particle_2020}.  Cherenkov light curve is essentially instantaneous, modeled by a Dirac $\delta(t)$ function.

Photons captured by a PMT are affected by transit time spread (TTS).  In our Monte Carlo setup, the effective light curve $\Phi(t)$ at PMT is modeled as an exponential distribution convoluted with a Gaussian~\cite{li_separation_2016}, known as \textit{ex-Gaussian} or \textit{exponentially modified Gaussian},
\begin{align}
    \Phi(t) = \frac{1}{2\tau} \exp\left(\frac{\sigma^2}{2\tau^2}-\frac{t-t_0}{\tau}\right) \left[1 - \erf\left( \frac{\sigma}{\sqrt{2}\tau} - \frac{t-t_0}{\sqrt{2}\sigma} \right)\right]
    \label{eq:time-pro}
\end{align}
where $t_0$ is when the exponential starts and $\tau$ is the decay life time.  $\sigma$ encodes the timing uncertainty mainly from TTS.  $\Phi(t)$ of Cherenkov light is a pure Gaussian without the exponential, or equivalently taking the limit $\tau \rightarrow 0$.  Figure~\ref{fig:time-pro} gives several examples of $\Phi(t)$.

\begin{figure}
  \centering
  \resizebox{0.6\textwidth}{!}{\input{figures/profile.pgf}}
  \caption{\label{fig:time-pro} Light curve $\tau$=20ns $\sigma$=10ns}
\end{figure}

\subsection{Single PE Response}
A photon can produce a PE at the PMT photocathode.  The PE is then accelerated, collected and amplified into $\num[retain-unity-mantissa=false]{\sim 1e7}$ electrons.  The electrons forms a voltage pulse $V_\mathrm{PE}(t)$ in the PMT output and is acquired by the digitizers as a time series called a \textit{waveform} $w(t)$~(Fig.~\ref{fig:spe}).

\begin{figure}[H]
  \begin{subfigure}{.49\textwidth}
    \centering
    \resizebox{\textwidth}{!}{\input{figures/spe.pgf}}
    \caption{\label{fig:spe} SPE response of PMT in \eqref{eq:dayaspe}}
  \end{subfigure}
  \begin{subfigure}{.49\textwidth}
    \centering
    \resizebox{\textwidth}{!}{\input{figures/wave.pgf}}
    \caption{\label{fig:pile} Pile-up and white noise in a PMT waveform}
  \end{subfigure}
  \caption{A single PE induces a voltage pulse as in \subref{fig:spe}.  They pile up after arriving at one PMT, manifested in the waveform in \subref{fig:pile}.}
\end{figure}

We use the parameterization of Daya Bay~\cite{jetter_pmt_2012} for the single PE response pulse,
\begin{equation}
  V_\mathrm{PE}(t) = V_{0}\exp\left[-\frac{1}{2}\left(\frac{\log(t/\tau_\mathrm{PE})}{\sigma_\mathrm{PE}}\right)^{2}\right]
  \label{eq:dayaspe}
\end{equation}
where $\tau_\mathrm{PE}=\SI{8}{ns}$, $\sigma_\mathrm{PE}=\SI{0.5}{ns}$ are shape parameters and $V_{0}=\SI{14.08}{mV}$, see Fig.~\ref{fig:spe}.  There can be several PEs piling up in a waveform.  We model the waveform as
\begin{equation}
  \label{eq:1}
  w(t) = \sum_{i=1}^{N_\mathrm{PE}} q_i V_\mathrm{PE}(t-t_i) + \epsilon(t)
\end{equation}
where $N_\mathrm{PE}$ is the number of PEs obeying Poisson distribution with expectation $\mu$, $t_i$ is the hittime of the $i$-th PE sampled from the light curve $\Phi(t)$ in \eqref{eq:time-pro} and Fig.~\ref{fig:time-pro}, $q_i$ is the relative charge of the $i$-th PE from a normal distribution $\mathcal{N}(1,\sigma_{q}^2)$, and $\epsilon(t)$ is a Gaussian white noise.  A waveform example is illustrated in Fig.~\ref{fig:pile}.

\subsection{Timing Measurement}
Failing to separate them can worse the timing resolution.

We usually record the time of the first PE according to the threshold of voltage, $V_\mathrm{th}$, and total charge in a DAQ window. The voltage which is higher than a certain threshold is assumed to be the consequence of photoelectron. The total charge is the integration of the waveform. Charge induced single photoelectron (SPE) can be a wide distribution (usually truncated normal distribution, mean is $\mu_{g}$, the standard deviation is $\sigma_{g}$) rather than a single value (see the black curve in figure~\ref{fig:recchargehist}). In these practical scenarios, one waveform is converted to a pair of numbers. More detailed information on the waveform was lost. 

The typical combination of decay time ($\tau$) and transit time spread ($\sigma$) are listed in Fig.~\ref{fig:reso-diff}. We take the value of $\tau$ according to typical liquid scintillator used in JUNO \cite{ludhova_particle_2020}. For every combination of PE number expectation $\mu$, decay time $\tau$ and TTS $\sigma$, a sample set (size $N=10,000$) is generated to estimate the timing resolution $\delta$. 

The estimation result of $t_{0}$ using simulated data is shown in figure~\ref{fig:reso-diff}, where $\delta_{\mathrm{1st}}$ and $\delta_{\mathrm{all}}$ are timing resolution using the first PE and all PE when reconstruction, respectively. The vertical axis is the ratio, $\delta_{\mathrm{all}}/\delta_{\mathrm{1st}}$. Because time resolution estimation here is only based on simulated data, the result will reveal the advantage of using detailed information of all PE. It is distinct that the timing resolution is smaller when reconstructing rise time using all PE. 

\begin{figure}[H]
    \centering
    \scalebox{0.5}{\input{figures/vs-deltadiv.pgf}}
    \caption{\label{fig:reso-diff} Timing resolution improved by waveform analysis}
\end{figure}

We can use Maximum Likelihood Estimation (MLE) to estimate $t_{0}$ in formula \eqref{eq:time-pro}, which is the starting time of light curve, using charge $q$ and corresponding hittime. The difference between real starting time $t_{0tru}$ and reconstructed starting time $\hat{t}_0$ are collected to produce the starting time residual ($\Delta t_{0}=\hat{t}_0-t_0$) distribution. The time resolution $\delta$ is the standard deviation, $s$, of the starting time residual distribution, which is formula \eqref{eq:resolution}. The likelihood $\mathcal{L}$ defined in MLE is formula \eqref{eq:likelihood}. 

\begin{align}
  \delta &= s_{\Delta t_{0}} = s_{\hat{t}_0-t_0} \label{eq:resolution} \\
  \mathcal{L}(t_{0}) &= e^{-\mu}\Pi_{i=0}^{N}P_{t}(t_{i})^{q_{i}} \label{eq:likelihood}
\end{align}


Before taking a deep look into the methods, input and output need to be defined. The input for waveform analysis is pedestal subtracted PMT waveform (see figure~\ref{fig:input}), and the output is the $q_{rec}$ sequence (see figure~\ref{fig:output}), which is interpreted as an approximation of light curve. 

\begin{figure}[H]
  \begin{subfigure}{.5\textwidth}
    \centering
    \resizebox{\textwidth}{!}{\input{figures/wave.pgf}}
    \caption{\label{fig:input} Input}
  \end{subfigure}
  \begin{subfigure}{.5\textwidth}
    \centering
    \resizebox{\textwidth}{!}{\input{figures/charge.pgf}}
    \caption{\label{fig:output} Output}
  \end{subfigure}
  \caption{Waveform analysis takes PMT waveform as input and infer the timing and charge of the PEs in the output.}
\end{figure}

The histogram of $N_\mathrm{PE}$ when $\mu=5$ shows in the figure (see figure~\ref{fig:penum}). 

\begin{figure}[H]
    \centering
    \scalebox{0.4}{\input{figures/penum.pgf}}
    \caption{\label{fig:penum} $N_\mathrm{PE}$ histogram}
\end{figure}

% section Towards Timing Resolution (end)
